<!-- Copied minimal flashing UI from root for Mac bundle (trimmed) -->
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' http://localhost:* ws://localhost:*; img-src 'self' data:; font-src 'self' data:; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"/>
<title>ESP32 Flasher - Tally Hub</title>
<style>*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:2rem;color:#fff;} .container{max-width:840px;margin:0 auto;} h1{text-align:center;margin-bottom:1rem;font-size:2.2rem;} .card{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1.5rem;margin-bottom:1.5rem;backdrop-filter:blur(10px);} button{cursor:pointer;border:none;border-radius:10px;padding:.65rem 1rem;font-weight:600;background:#007AFF;color:#fff;} .grid{display:grid;gap:1rem;} .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));} select,input{width:100%;padding:.55rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff;font-family:inherit;font-size:.8rem;} .log{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:.6rem;font-size:.65rem;line-height:1.2;max-height:200px;overflow:auto;white-space:pre-wrap;}
</style></head><body>
<div class="container">
  <h1>ðŸ”Œ Firmware Flash</h1>
  <div class="card">
    <div class="grid cols-2">
      <div><label style="font-size:.65rem;letter-spacing:.5px;opacity:.75;">Device</label><select id="deviceSelect"><option value="m5stick">M5Stick Tally</option><option value="m5stick_plus2">M5Stick Plus2</option><option value="esp32-1732s019">ESP32-1732S019</option></select></div>
      <div><label style="font-size:.65rem;letter-spacing:.5px;opacity:.75;">Firmware Version</label><select id="fwVersion"></select></div>
    </div>
    <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
      <button onclick="startFlash()">Flash</button>
      <button style="background:rgba(255,255,255,.25);" onclick="refreshFirmware()">Refresh Firmware List</button>
      <span id="flashStatus" style="font-size:.65rem;align-self:center;opacity:.85;"></span>
    </div>
  </div>
  <div class="card">
    <div class="log" id="log">Idle...</div>
  </div>
</div>
<script>
async function fetchJSON(u){const r=await fetch(u);return r.json();}
async function refreshFirmware(){const sel=document.getElementById('fwVersion'); sel.innerHTML='<option>Loading...</option>'; try{const resp=await fetch('/firmware/'); const text=await resp.text(); const matches=[...text.matchAll(/href=\"([^\"/]+)\"/g)].map(m=>m[1]).filter(n=>n.endsWith('.bin')); if(!matches.length){sel.innerHTML='<option value="">No firmware found</option>'; return;} sel.innerHTML=matches.map(f=>`<option value="${f}">${f}</option>`).join(''); }catch(e){sel.innerHTML='<option>Error</option>';}}
function log(msg){const el=document.getElementById('log'); el.textContent += (el.textContent.endsWith('\n')?'':'\n')+msg; el.scrollTop=el.scrollHeight;}
async function startFlash(){const status=document.getElementById('flashStatus'); status.textContent='Starting...'; log('Opening Web Serial (requires Chrome)'); try{if(!('serial' in navigator)){status.textContent='Web Serial unsupported';log('Web Serial API not supported');return;} const port=await navigator.serial.requestPort(); await port.open({baudRate:115200}); status.textContent='Connected'; log('Port opened'); /* Further flashing logic would stream the .bin via esptool.js or custom protocol â€“ omitted for brevity */ log('NOTE: Full flashing logic trimmed in Mac bundle mini version. Use web flasher if needed.'); await port.close(); status.textContent='Done (demo)'; }catch(e){ status.textContent='Error'; log('Error: '+e.message); }}
refreshFirmware();
</script>
</body></html>
