name: Sync Flasher Page to User Site

on:
  push:
    branches: [ main ]
    paths:
      - 'public/flash.html'
      - '.github/workflows/sync-flasher.yml'
  workflow_dispatch:

jobs:
  sync:
    name: Copy public/flash.html to tallyhubpro.github.io
    runs-on: ubuntu-latest
    steps:
      - name: Check for required token
        run: |
          if [ -z "${{ secrets.PAGES_SYNC_TOKEN }}" ]; then
            echo "::error::PAGES_SYNC_TOKEN secret is not set. Please add it in repository settings."
            echo "::error::Go to Settings → Secrets and variables → Actions → New repository secret"
            echo "::error::Name: PAGES_SYNC_TOKEN"
            echo "::error::Value: A Personal Access Token with 'repo' scope"
            exit 1
          fi
      
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout user site repo
        uses: actions/checkout@v4
        with:
          repository: tallyhubpro/tallyhubpro.github.io
          path: user-site
          token: ${{ secrets.PAGES_SYNC_TOKEN }}
          fetch-depth: 0

      - name: Copy flasher page
        run: |
          cp public/flash.html user-site/flash.html
          mkdir -p user-site/firmware
          cp -r public/firmware/* user-site/firmware/ 2>/dev/null || true
          echo "Copied flash.html and firmware/ to user-site repo"

      - name: Commit & push if changed
        working-directory: user-site
        run: |
          git config user.name "tallyhub-bot"
          git config user.email "actions@users.noreply.github.com"
          git add flash.html firmware/
          
          if git diff --quiet --staged; then
            echo "No changes detected; skipping commit."
          else
            git commit -m "chore: sync flash.html and firmware from Tallyhub repo"
            git push origin HEAD:main
            echo "✅ Successfully synced files to tallyhubpro.github.io"
          fi

      - name: Summary
        run: |
          echo "Sync complete. If this is the first run ensure GitHub Pages is enabled for tallyhubpro.github.io repo." >> $GITHUB_STEP_SUMMARY
